from services import knowledge_base


def get_nudge_block(assumption: dict) -> list:
    if not all(k in assumption for k in ("id", "text")):
        raise ValueError("Assumption dictionary must contain 'id' and 'text' keys.")
    return [
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": (
                    ":alarm_clock: *Stale Assumption Alert*\n\n"
                    "We haven't tested this in a while:\n"
                    f"> *{assumption['text']}*\n\nDo we still believe this is true?"
                ),
            },
        },
        {
            "type": "actions",
            "elements": [
                {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "Still True (Keep)"},
                    "style": "primary",
                    "action_id": "keep_assumption",
                    "value": assumption["id"],
                },
                {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "Invalid (Archive)"},
                    "style": "danger",
                    "action_id": "archive_assumption",
                    "value": assumption["id"],
                },
                {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "Generate Experiment"},
                    "action_id": "gen_experiment_modal",
                    "value": assumption["text"],
                },
            ],
        },
    ]


def get_ai_summary_block(ai_text: str, provenance: str | None = None) -> list:
    """Generates Slack blocks for an AI summary."""
    blocks = [
        {
            "type": "section",
            "text": {"type": "mrkdwn", "text": ":sparkles: *Evidently AI Analysis*"},
        },
        {"type": "section", "text": {"type": "mrkdwn", "text": ai_text}},
    ]
    context_text = provenance or "Generated by Google Gemini via Evidently"
    blocks.append({"type": "context", "elements": [{"type": "mrkdwn", "text": context_text}]})
    return blocks


def error_block(message: str) -> list:
    """User-friendly error banner."""
    return [
        {
            "type": "section",
            "text": {"type": "mrkdwn", "text": f"ðŸš§ *Something went wrong.* {message}"},
        }
    ]


def method_card(method: str) -> dict:
    description = knowledge_base.get_case_study(method) or "Nesta Playbook method."
    return {
        "type": "section",
        "text": {"type": "mrkdwn", "text": f"*{method}*\n{description}"},
        "accessory": {
            "type": "button",
            "text": {"type": "plain_text", "text": "View Case Study"},
            "action_id": "view_case_study",
            "value": method,
        },
    }


def case_study_modal(method: str) -> dict:
    description = knowledge_base.get_case_study(method) or "Case study coming soon."
    return {
        "type": "modal",
        "callback_id": "case_study_modal",
        "title": {"type": "plain_text", "text": "Case Study"},
        "close": {"type": "plain_text", "text": "Close"},
        "blocks": [
            {"type": "header", "text": {"type": "plain_text", "text": method}},
            {"type": "section", "text": {"type": "mrkdwn", "text": description}},
        ],
    }
